when:
  - event: [push, manual]
  - branch: [main]

steps:
  - name: Fetch and Initialize Credentials
    when:
      - event: [push, manual]
      - branch: [main]
    image: registry.mist-project.app/mist-shared/alpine-ci:latest
    environment:
      OP_SERVICE_ACCOUNT_TOKEN:
        from_secret: OP_TOKEN
      OP_VAULT:
        from_secret: OP_VAULT
      TENANT_ACCOUNT_ID: "k5q7ysjcaiu3cnfyjx7gjyevai"

    commands:
      - chmod +x helpers/fetch_creds_op.sh
      - ./helpers/fetch_creds_op.sh

  - name: Build latest binary and deploy
    when:
      - event: [push, manual]
      - branch: [main]
    image: registry.mist-project.app/mist-shared/alpine-ci:latest
    environment:
      ANSIBLE_HOST_KEY_CHECKING: False
    commands:
      - source .tmpenvs
      - |
        ansible-playbook -i ansible/inventory/hosts.ini \
          ansible/playbooks/deploy.yml \
          --extra-vars "ansible_ssh_private_key_file=key.pem" \
          --extra-vars "ansible_user=$TENANT_USERNAME" \
          --extra-vars "DISCORD_APPLICATION_ID=$DISCORD_APPLICATION_ID" \
          --extra-vars "DISCORD_PUBLIC_KEY=$DISCORD_PUBLIC_KEY" \
          --extra-vars "DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN" \
